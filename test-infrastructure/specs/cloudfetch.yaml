# Copyright (c) 2025 ADBC Drivers Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# CloudFetch Test Specifications
#
# These tests validate driver behavior when CloudFetch operations fail.
# CloudFetch is Databricks' high-performance result retrieval system that downloads
# results directly from cloud storage (Azure Blob, S3, GCS).

test_suite: CloudFetch
priority: Critical

tests:
  - id: CLOUDFETCH-001
    name: Expired Link Recovery
    priority: Critical
    description: |
      Validates that driver correctly handles expired CloudFetch download links
      by calling FetchResults again to get a fresh link.

    jira: PECOBLR-1131
    proxy_scenario: cloudfetch_expired_link

    steps:
      - action: reset_call_history
        description: Clear proxy call history before test

      - action: enable_failure_scenario
        scenario: cloudfetch_expired_link

      - action: execute_test
        description: Execute query with expired link scenario enabled
        execute_query: "SELECT * FROM main.tpcds_sf1_delta.catalog_returns"
        read_rows: 10000  # Read multiple batches to ensure CloudFetch is used

    assertions:
      - type: no_error
        description: Query completes successfully despite expired link

      - type: result_not_null
        description: Query returns valid result

      - type: thrift_call_exists
        method: FetchResults
        field: startRowOffset
        value: 0
        description: Driver called FetchResults with offset=0 to refresh expired URL

    notes: |
      ExecuteStatement returns initial links via directResults (no initial FetchResults call).
      We only see FetchResults(0) when the driver refreshes the expired URL.

  - id: CLOUDFETCH-002
    name: 403 Forbidden Recovery
    priority: Critical
    description: |
      Validates that driver correctly handles 403 Forbidden errors from CloudFetch
      by calling FetchResults again to get a new link.

    jira: ES-1624602
    proxy_scenario: cloudfetch_403

    steps:
      - action: reset_call_history
        description: Clear proxy call history before test

      - action: enable_failure_scenario
        scenario: cloudfetch_403

      - action: execute_test
        description: Execute query with 403 scenario enabled
        execute_query: "SELECT * FROM main.tpcds_sf1_delta.catalog_returns"
        read_rows: 10000  # Read multiple batches to ensure CloudFetch is used

    assertions:
      - type: no_error
        description: Query completes successfully despite 403 error

      - type: result_not_null
        description: Query returns valid result

      - type: thrift_call_exists
        method: FetchResults
        field: startRowOffset
        value: 0
        description: Driver called FetchResults with offset=0 to refresh expired URL

    notes: |
      ExecuteStatement returns initial links via directResults (no initial FetchResults call).
      We only see FetchResults(0) when the driver refreshes after 403 error.

  - id: CLOUDFETCH-003
    name: Timeout Retry with Backoff
    priority: Critical
    description: |
      Validates that driver correctly handles CloudFetch download timeouts
      by retrying with exponential backoff (does NOT refresh URL via FetchResults).

    jira: BL-13239
    proxy_scenario: cloudfetch_timeout

    driver_config:
      cloudfetch_timeout_minutes: 1

    steps:
      - action: reset_call_history
        description: Clear proxy call history before test

      - action: enable_failure_scenario
        scenario: cloudfetch_timeout
        config:
          duration_seconds: 65  # Exceeds 60s timeout

      - action: execute_test
        description: Execute query with timeout scenario (will timeout at 60s)
        execute_query: "SELECT * FROM main.tpcds_sf1_delta.catalog_returns"
        driver_config: driver_config

    assertions:
      - type: no_error
        description: Query completes successfully despite timeout

      - type: result_not_null
        description: Query returns valid result

      - type: duplicate_cloud_fetch_urls
        description: Driver retried the same CloudFetch URL after timeout

    notes: |
      This test may take 60+ seconds as it waits for CloudFetch timeout.
      Driver should use generic retry logic with exponential backoff,
      NOT refresh the URL via FetchResults (timeout != expired link).

  - id: CLOUDFETCH-004
    name: Connection Reset During Download
    priority: Critical
    description: |
      Validates that driver correctly handles connection resets during CloudFetch downloads
      by retrying with exponential backoff (does NOT refresh URL via FetchResults).

    jira: BL-13580
    proxy_scenario: cloudfetch_connection_reset

    steps:
      - action: reset_call_history
        description: Clear proxy call history before test

      - action: enable_failure_scenario
        scenario: cloudfetch_connection_reset

      - action: execute_test
        description: Execute query with connection reset scenario enabled
        execute_query: "SELECT * FROM main.tpcds_sf1_delta.catalog_returns"
        read_rows: 10000  # Read multiple batches to ensure CloudFetch is used

    assertions:
      - type: no_error
        description: Query completes successfully despite connection reset

      - type: result_not_null
        description: Query returns valid result

      - type: duplicate_cloud_fetch_urls
        description: Driver retried the same CloudFetch URL after connection reset

    notes: |
      Driver should use generic retry logic with exponential backoff (delays of 1s, 2s, 3s),
      NOT refresh the URL via FetchResults (connection error != expired link).

# Future tests (not yet implemented)
planned_tests:
  - id: CLOUDFETCH-005
    name: 400 Bad Request Error
    proxy_scenario: cloudfetch_400
    status: planned

  - id: CLOUDFETCH-006
    name: 404 Not Found Error
    proxy_scenario: cloudfetch_404
    status: planned

  - id: CLOUDFETCH-007
    name: 405 Method Not Allowed Error
    proxy_scenario: cloudfetch_405
    status: planned

  - id: CLOUDFETCH-008
    name: 412 Precondition Failed Error
    proxy_scenario: cloudfetch_412
    status: planned

  - id: CLOUDFETCH-009
    name: 500 Internal Server Error
    proxy_scenario: cloudfetch_500
    status: planned

  - id: CLOUDFETCH-010
    name: 503 Service Unavailable Error
    proxy_scenario: cloudfetch_503
    status: planned
