# Copyright (c) 2025 ADBC Drivers Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Session Lifecycle Test Specifications
#
# These tests validate driver behavior for session management operations including
# OpenSession, CloseSession, session expiration, and timeout handling.

test_suite: Session Lifecycle
priority: Critical

# Common test configuration
test_config:
  simple_query: "SELECT 1 AS test_value"

# Implementation guidance for code generation
implementation_notes:
  query_execution: |
    Read result batches using the driver's batch reading API (e.g., Arrow in C#).
    Always properly dispose of statements and readers.
    Include null checks for results.

  timing_measurement: |
    Measure elapsed time from operation start to completion.
    Use high-resolution timing APIs available in your language.

  retry_count_tracking: |
    For retry tests, get initial call count AFTER enabling scenario but BEFORE the operation.
    Then compare final count to initial count to see how many retries occurred.

  error_checking: |
    Check full error context (not just error message) for pattern matching.
    Use case-insensitive comparison for error patterns.

tests:
  - id: SESSION-001
    name: Basic OpenSession Success
    priority: Critical
    description: |
      Validates that driver can successfully open a session with valid credentials
      and receives a valid session handle.

    steps:
      - action: open_connection
        description: Create connection (triggers OpenSession)

      - action: execute_query
        query: test_config.simple_query
        read_batches: 1
        description: Execute query to verify session is valid

    assertions:
      - type: query_succeeds
        description: Query completes without error

      - type: thrift_call_count
        method: OpenSession
        expected: 1
        description: Driver called OpenSession exactly once

    notes: |
      This is the most basic test. All other session tests depend on this working.

  - id: SESSION-002
    name: CloseSession on Active Session
    priority: Critical
    description: |
      Validates that driver can successfully close an active session and
      properly cleans up resources.

    steps:
      - action: open_connection
        description: Create connection

      - action: execute_query
        query: test_config.simple_query
        read_batches: 1
        description: Execute query to ensure session is active

      - action: close_connection
        description: Dispose connection (triggers CloseSession)

    assertions:
      - type: thrift_call_count
        method: CloseSession
        expected: 1
        description: Driver called CloseSession exactly once

  - id: SESSION-003
    name: Operation on Closed Session
    priority: Critical
    description: |
      Validates that driver properly handles attempts to use a session handle
      after the session has been closed.

    jira: ES-610899
    proxy_scenario: invalid_session_handle

    steps:
      - action: open_connection
        description: Create connection

      - action: execute_query
        query: test_config.simple_query
        read_batches: 1
        description: Execute first query to establish session

      - action: enable_failure_scenario
        scenario: invalid_session_handle
        description: Proxy will invalidate session on next operation

      - action: execute_query
        query: test_config.simple_query
        expect_error: true
        description: Attempt query on invalidated session

    assertions:
      - type: error_thrown
        error_pattern: session|INVALID_HANDLE
        description: Driver throws appropriate error for invalid session

  - id: SESSION-004
    name: Session Timeout Due to Inactivity
    priority: High
    description: |
      Validates that driver handles session timeout when session expires due to inactivity.
      Proxy simulates SESSION_EXPIRED error that server would return after timeout.

    proxy_scenario: session_timeout_premature
    jira: ES-1661289

    driver_config:
      session_idle_timeout_minutes: 1

    steps:
      - action: reset_call_history
        description: Clear proxy call history before test

      - action: open_connection
        driver_config: driver_config
        description: Create connection with 1-minute session timeout

      - action: execute_query
        query: test_config.simple_query
        read_batches: 1
        description: Execute query to establish working session

      - action: enable_failure_scenario
        scenario: session_timeout_premature
        description: Simulate session expiration on next operation

      - action: execute_query
        query: test_config.simple_query
        expect_error: true
        description: Attempt query on expired session

    assertions:
      - type: error_thrown
        error_pattern: session|expired|timeout
        description: Driver detects session expiration and reports error

    notes: |
      Proxy scenario simulates SESSION_EXPIRED error without actual 70-second wait.
      In production, server would return this after idle timeout expires.

  - id: SESSION-005
    name: Auto-Reconnect on Communication Error
    priority: High
    status: skipped
    description: |
      Validates that driver automatically reconnects when communication errors occur
      during query execution (connection drops, network timeouts).

    proxy_scenario: connection_drop_during_metadata
    jira: ES-1661289

    driver_config:
      auto_reconnect: true

    steps:
      - action: reset_call_history

      - action: open_connection
        driver_config: driver_config

      - action: execute_query
        query: test_config.simple_query
        read_batches: 1
        description: Execute first query to establish working session

      - action: enable_failure_scenario
        scenario: connection_drop_during_metadata

      - action: execute_query
        query: test_config.simple_query
        read_batches: 1
        description: Query with auto-reconnect on communication error

    assertions:
      - type: query_succeeds
        description: Query succeeds after auto-reconnect

      - type: thrift_call_count_increased
        method: OpenSession
        description: Driver opened new session automatically

    notes: |
      Currently skipped - auto-reconnect feature not yet implemented in driver.

  - id: SESSION-006
    name: CloseSession with Active Operations
    priority: High
    description: |
      Validates driver behavior when CloseSession is called while
      operations are still running.

    jira: XTA-11040

    steps:
      - action: reset_call_history

      - action: open_connection

      - action: start_long_query
        query: "SELECT count(*) FROM range(1, 2000) CROSS JOIN range(1, 2000)"
        description: Start query that takes 2-3 seconds

      - action: close_connection
        delay_after_start_ms: 1000
        description: Close connection 1 second after query starts

    assertions:
      - type: thrift_call_count_increased
        method: CloseSession
        description: CloseSession was called despite active operations

      - type: connection_disposed_successfully
        description: Connection disposed without hanging

    notes: |
      Driver relies on server-side cleanup when CloseSession is called.
      HiveServer2 spec requires server to clean up operations when session closes.

  - id: SESSION-007
    name: Concurrent Session Close
    priority: Low
    status: skipped
    description: |
      Validates that driver handles multiple threads attempting to
      close the same session simultaneously.

    steps:
      - action: open_connection

      - action: execute_query
        query: test_config.simple_query
        read_batches: 1

      - action: concurrent_close
        threads: 3
        description: Attempt to close from 3 threads simultaneously

    assertions:
      - type: no_error
        description: No errors thrown from any thread

      - type: thrift_call_count
        method: CloseSession
        expected: 1
        description: Only one CloseSession call actually sent

    notes: |
      Currently skipped - causes deadlock in CI. Needs driver thread-safety investigation.

  - id: SESSION-008
    name: Session with Expired Credentials
    priority: High
    description: |
      Validates that driver handles OpenSession failure due to
      expired authentication credentials.

    proxy_scenario: expired_credentials

    steps:
      - action: reset_call_history

      - action: enable_failure_scenario
        scenario: expired_credentials

      - action: open_connection
        expect_error: true
        description: Attempt to open session with expired token

    assertions:
      - type: error_thrown
        error_pattern: auth|token|credential
        description: Driver reports authentication failure

  - id: SESSION-009
    name: OpenSession Network Timeout
    priority: Medium
    status: skipped
    description: |
      Validates that driver handles network timeout during OpenSession request.
      Test takes 35 seconds due to network delay.

    proxy_scenario: network_timeout_open_session

    driver_config:
      temporarily_unavailable_retry_timeout: 20

    steps:
      - action: reset_call_history

      - action: enable_failure_scenario
        scenario: network_timeout_open_session
        config:
          duration_seconds: 35

      - action: open_connection
        driver_config: driver_config
        expect_error: true
        description: Attempt to open with 35s delay (exceeds 20s timeout)

    assertions:
      - type: error_thrown
        error_pattern: timeout|connection|network
        description: Driver reports timeout error

      - type: timeout_duration
        expected_seconds: 20
        tolerance_seconds: 5
        description: Timeout occurred around 20 seconds, not 35

    notes: |
      Skipped by default due to 35-second duration. Enable for comprehensive testing.

  - id: SESSION-010
    name: CloseSession Network Failure
    priority: Low
    description: |
      Validates that driver handles network failure during CloseSession
      and still cleans up local resources.

    proxy_scenario: network_failure_close_session

    steps:
      - action: reset_call_history

      - action: open_connection

      - action: execute_query
        query: test_config.simple_query
        read_batches: 1

      - action: enable_failure_scenario
        scenario: network_failure_close_session

      - action: close_connection
        allow_error: true
        description: Close with network failure

    assertions:
      - type: connection_disposed
        description: Connection cleanup completed despite network error

      - type: error_optional
        error_pattern: connect|response ended|network|connection
        description: If error thrown, should be network-related

    notes: |
      Driver may throw network error during Dispose() or handle silently.
      Both acceptable as long as local resources cleaned up.

  - id: SESSION-011
    name: HTTP 503 Service Unavailable Retry
    priority: Medium
    description: |
      Validates that driver automatically retries OpenSession when receiving
      HTTP 503 Service Unavailable with exponential backoff.

    proxy_scenario: service_unavailable_503_open_session

    steps:
      - action: reset_call_history

      - action: enable_failure_scenario
        scenario: service_unavailable_503_open_session
        description: Proxy returns 503 once then auto-disables

      - action: open_connection
        description: Connection should succeed after retry

      - action: execute_query
        query: test_config.simple_query
        read_batches: 1
        description: Verify connection is valid

    assertions:
      - type: query_succeeds
        description: Connection established after retry

      - type: retry_backoff_delay
        minimum_seconds: 0.8
        description: Should wait ~1 second before retry (with jitter)

      - type: thrift_call_count
        method: OpenSession
        expected: ">= 2"
        description: OpenSession called at least twice (initial + retry)

    notes: |
      Proxy scenario auto-disables after first 503, simulating transient error.
      Driver uses exponential backoff: 1s (with 80-120% jitter), then 2s, 4s, etc.

  - id: SESSION-012
    name: Other Transient HTTP Errors Retry
    priority: Medium
    description: |
      Validates that driver automatically retries OpenSession when receiving
      other retryable HTTP errors (408, 429, 502, 504).

    proxy_scenarios:
      - request_timeout_408_open_session
      - too_many_requests_429_open_session
      - bad_gateway_502_open_session
      - gateway_timeout_504_open_session

    steps:
      - action: reset_call_history

      - action: enable_failure_scenario
        scenario: <one_of_above>
        description: Proxy returns error once then auto-disables

      - action: open_connection

      - action: execute_query
        query: test_config.simple_query
        read_batches: 1

    assertions:
      - type: query_succeeds
        description: Connection established after retry

      - type: retry_backoff_delay
        minimum_seconds: 0.8
        description: Should wait ~1 second before retry

      - type: thrift_call_count
        method: OpenSession
        expected: ">= 2"
        description: OpenSession called at least twice

    notes: |
      Implemented as Theory test with InlineData for each HTTP status code.
      All scenarios auto-disable after first error, simulating transient failures.

  - id: SESSION-016
    name: Keep-Alive During Long Result Fetching
    priority: High
    description: |
      Validates that driver sends periodic GetOperationStatus calls to keep
      the session alive during long-running result fetching operations.

    proxy_scenario: long_running_cloud_fetch
    jira: ES-1661289

    driver_config:
      fetch_heartbeat_interval: 5

    steps:
      - action: reset_call_history

      - action: enable_failure_scenario
        scenario: long_running_cloud_fetch
        config:
          duration_seconds: 15

      - action: open_connection
        driver_config: driver_config

      - action: execute_query
        query: "SELECT * FROM main.tpcds_sf1_delta.catalog_returns"
        fetch_all_batches: true
        description: Fetch all results (takes 15 seconds)

    assertions:
      - type: query_succeeds
        description: Result fetching completes successfully

      - type: all_rows_fetched
        description: All result rows successfully fetched

      - type: thrift_call_count
        method: GetOperationStatus
        expected: ">= 3"
        description: At least 3 keep-alive calls during 15s fetch (at 0s, 5s, 10s)

    notes: |
      DatabricksOperationStatusPoller starts when reader is created.
      Makes immediate first call, then waits 5 seconds between calls.
      With 15-second operation: calls at t=0s, t=5s, t=10s.

# Planned tests (not yet implemented)
planned_tests:
  - id: SESSION-006-PLANNED
    name: Session Handle Reuse After Close
    status: planned
    notes: |
      Validate that driver prevents reuse of session handle after CloseSession.
      Similar to SESSION-003 but explicitly tests handle reuse.

  - id: SESSION-007-PLANNED
    name: Multiple Concurrent Sessions
    status: planned
    notes: |
      Validate that driver can maintain multiple concurrent sessions independently.
      Open 2 sessions, execute queries on both, verify operations don't interfere.

  - id: SESSION-008-PLANNED
    name: OpenSession with Configuration Parameters
    status: planned
    notes: |
      Validate that driver correctly passes session configuration parameters
      to OpenSession request (e.g., spark.sql.adaptive.enabled).

  - id: SESSION-009-PLANNED
    name: GetInfo on Valid Session
    status: planned
    notes: |
      Validate that driver can retrieve server information using GetInfo
      on an active session.
