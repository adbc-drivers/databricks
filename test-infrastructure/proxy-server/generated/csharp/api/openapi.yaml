openapi: 3.0.0
info:
  description: |
    Control API for the Thrift Protocol Test Proxy Server.

    Enables runtime control of failure injection scenarios for testing ADBC drivers.
    Tests can enable/disable scenarios to inject failures like connection resets,
    timeouts, and error responses during CloudFetch downloads or Thrift operations.

    ## Usage Pattern

    1. List available scenarios with `GET /scenarios`
    2. Enable a scenario with `POST /scenarios/{name}/enable`
    3. Trigger the scenario by making a request through the proxy
    4. Scenario auto-disables after first injection (one-shot behavior)
    5. Optionally disable manually with `POST /scenarios/{name}/disable`

    ## Base URL

    Default: `http://localhost:8081` (configurable via `proxy.api_port` in config)
  title: Thrift Protocol Test Proxy - Control API
  version: 1.0.0
servers:
- description: Default Control API endpoint
  url: http://localhost:8081
tags:
- description: Failure scenario management operations
  name: Scenarios
- description: Thrift method call tracking and verification
  name: Thrift Tracking
paths:
  /scenarios:
    get:
      description: |
        Returns a list of all configured failure scenarios with their current status.
        Each scenario includes its name, description, and enabled state.
      operationId: listScenarios
      responses:
        "200":
          content:
            application/json:
              example:
                scenarios:
                - name: cloudfetch_expired_link
                  description: "CloudFetch link expires, driver should retry via FetchResults"
                  enabled: false
                - name: connection_reset_during_fetch
                  description: Connection reset when fetching large result sets
                  enabled: true
              schema:
                $ref: "#/components/schemas/ScenarioList"
          description: List of scenarios retrieved successfully
      summary: List all available failure scenarios
  /scenarios/{name}/enable:
    post:
      description: |
        Enables a failure scenario by name. Once enabled, the scenario will trigger
        on the next matching request (CloudFetch download or Thrift operation).

        **Note:** Scenarios auto-disable after first injection (one-shot behavior).
      operationId: enableScenario
      parameters:
      - description: The unique name of the failure scenario (from proxy-config.yaml)
        example: cloudfetch_expired_link
        explode: false
        in: path
        name: name
        required: true
        schema:
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              example:
                scenario: cloudfetch_timeout
                enabled: true
              schema:
                $ref: "#/components/schemas/ScenarioStatus"
          description: Scenario enabled successfully
        "404":
          content:
            text/plain:
              schema:
                example: "Scenario not found: invalid_scenario_name"
                type: string
          description: Scenario not found
      summary: Enable a failure scenario
  /scenarios/{name}/disable:
    post:
      description: |
        Disables a failure scenario by name. Disabled scenarios will not trigger
        even if matching requests are made through the proxy.

        **Note:** Scenarios auto-disable after injection, so manual disable is
        typically only needed to cancel a scenario before it triggers.
      operationId: disableScenario
      parameters:
      - description: The unique name of the failure scenario (from proxy-config.yaml)
        example: cloudfetch_expired_link
        explode: false
        in: path
        name: name
        required: true
        schema:
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              example:
                scenario: cloudfetch_timeout
                enabled: false
              schema:
                $ref: "#/components/schemas/ScenarioStatus"
          description: Scenario disabled successfully
        "404":
          content:
            text/plain:
              schema:
                example: "Scenario not found: invalid_scenario_name"
                type: string
          description: Scenario not found
      summary: Disable a failure scenario
  /thrift/calls:
    get:
      description: |
        Returns the history of Thrift method calls tracked by the proxy.
        Includes method name, timestamp, message type, and sequence ID.

        **Note:** Call history is automatically reset when a scenario is enabled.
      operationId: getThriftCalls
      responses:
        "200":
          content:
            application/json:
              example:
                calls:
                - timestamp: 1.702918234567E9
                  method: ExecuteStatement
                  message_type: CALL
                  sequence_id: 1
                - timestamp: 1.702918235123E9
                  method: FetchResults
                  message_type: CALL
                  sequence_id: 2
                count: 2
                max_history: 1000
              schema:
                $ref: "#/components/schemas/ThriftCallHistory"
          description: Call history retrieved successfully
      summary: Get Thrift method call history
  /thrift/calls/reset:
    post:
      description: |
        Manually resets the Thrift call history to empty.

        **Note:** Call history is automatically reset when a scenario is enabled,
        so manual reset is typically not needed.
      operationId: resetThriftCalls
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/resetThriftCalls_200_response"
          description: Call history reset successfully
      summary: Reset Thrift call history
  /thrift/calls/verify:
    post:
      description: |
        Verifies that Thrift method calls match expected patterns.

        Supports four verification types:
        - **exact_sequence**: Exact match of method sequence
        - **contains_sequence**: Methods appear in order (not necessarily consecutive)
        - **method_count**: Verify specific method called N times
        - **method_exists**: Verify method was called at least once
      operationId: verifyThriftCalls
      requestBody:
        content:
          application/json:
            examples:
              exact_sequence:
                summary: Exact sequence match
                value:
                  type: exact_sequence
                  methods:
                  - ExecuteStatement
                  - FetchResults
                  - CloseOperation
              contains_sequence:
                summary: Contains sequence (in order)
                value:
                  type: contains_sequence
                  methods:
                  - ExecuteStatement
                  - FetchResults
              method_count:
                summary: Method count
                value:
                  type: method_count
                  method: FetchResults
                  count: 2
              method_exists:
                summary: Method exists
                value:
                  type: method_exists
                  method: ExecuteStatement
            schema:
              $ref: "#/components/schemas/ThriftVerificationRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ThriftVerificationResult"
          description: Verification result
        "400":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/verifyThriftCalls_400_response"
          description: Invalid request
      summary: Verify Thrift call sequence
components:
  parameters:
    ScenarioName:
      description: The unique name of the failure scenario (from proxy-config.yaml)
      example: cloudfetch_expired_link
      explode: false
      in: path
      name: name
      required: true
      schema:
        type: string
      style: simple
  schemas:
    ScenarioList:
      example:
        scenarios:
        - name: cloudfetch_expired_link
          description: "CloudFetch link expires, driver should retry via FetchResults"
          enabled: false
        - name: cloudfetch_expired_link
          description: "CloudFetch link expires, driver should retry via FetchResults"
          enabled: false
      properties:
        scenarios:
          description: List of all configured failure scenarios
          items:
            $ref: "#/components/schemas/Scenario"
          type: array
      required:
      - scenarios
      type: object
    Scenario:
      example:
        name: cloudfetch_expired_link
        description: "CloudFetch link expires, driver should retry via FetchResults"
        enabled: false
      properties:
        name:
          description: Unique scenario identifier (from YAML config)
          example: cloudfetch_expired_link
          type: string
        description:
          description: Human-readable description of the failure scenario
          example: "CloudFetch link expires, driver should retry via FetchResults"
          type: string
        enabled:
          description: Whether the scenario is currently enabled
          example: false
          type: boolean
      required:
      - description
      - enabled
      - name
      type: object
    ScenarioStatus:
      example:
        scenario: cloudfetch_timeout
        enabled: true
      properties:
        scenario:
          description: The scenario name
          example: cloudfetch_timeout
          type: string
        enabled:
          description: Current enabled state after the operation
          example: true
          type: boolean
      required:
      - enabled
      - scenario
      type: object
    ThriftCallHistory:
      example:
        calls:
        - method: method
          sequence_id: 6
          message_type: message_type
          timestamp: 0.8008281904610115
        - method: method
          sequence_id: 6
          message_type: message_type
          timestamp: 0.8008281904610115
        count: 1
        max_history: 5
      properties:
        calls:
          description: List of tracked Thrift method calls
          items:
            $ref: "#/components/schemas/ThriftCallHistory_calls_inner"
          type: array
        count:
          description: Number of calls in history
          type: integer
        max_history:
          description: Maximum number of calls stored (1000)
          type: integer
      required:
      - calls
      - count
      - max_history
      type: object
    ThriftVerificationRequest:
      example:
        method: method
        methods:
        - methods
        - methods
        count: 0
        type: exact_sequence
      properties:
        type:
          description: Type of verification
          enum:
          - exact_sequence
          - contains_sequence
          - method_count
          - method_exists
          type: string
        methods:
          description: Expected method sequence (for sequence verifications)
          items:
            type: string
          type: array
        method:
          description: Method name (for method_count/method_exists)
          type: string
        count:
          description: Expected count (for method_count)
          type: integer
      required:
      - type
      type: object
    ThriftVerificationResult:
      example:
        actual:
        - actual
        - actual
        method: method
        expected:
        - expected
        - expected
        verified: true
        expected_count: 6
        actual_count: 0
      properties:
        verified:
          description: Whether verification passed
          type: boolean
        actual:
          description: Actual method sequence
          items:
            type: string
          type: array
        expected:
          description: Expected method sequence
          items:
            type: string
          type: array
        method:
          description: Method name
          type: string
        actual_count:
          description: Actual count
          type: integer
        expected_count:
          description: Expected count
          type: integer
      required:
      - verified
      type: object
    resetThriftCalls_200_response:
      example:
        count: 0
        message: Call history reset
      properties:
        message:
          example: Call history reset
          type: string
        count:
          example: 0
          type: integer
      type: object
    verifyThriftCalls_400_response:
      example:
        error: Verification type required
      properties:
        error:
          example: Verification type required
          type: string
      type: object
    ThriftCallHistory_calls_inner:
      example:
        method: method
        sequence_id: 6
        message_type: message_type
        timestamp: 0.8008281904610115
      properties:
        timestamp:
          description: Unix timestamp
          type: number
        method:
          description: Thrift method name
          type: string
        message_type:
          type: string
        sequence_id:
          type: integer
      type: object
