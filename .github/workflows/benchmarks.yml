# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: Performance Benchmarks

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/benchmarks.yml'
      - 'csharp/src/**'
      - 'csharp/Benchmarks/**'
  workflow_dispatch:
    inputs:
      query:
        description: 'Custom SQL query to benchmark (optional)'
        required: false
        type: string

concurrency:
  group: ${{ github.repository }}-${{ github.sha }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  benchmark-net8:
    name: Benchmark (.NET 8.0)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: azure-prod
    env:
      DATABRICKS_SERVER_HOSTNAME: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_HTTP_PATH: ${{ secrets.TEST_PECO_WAREHOUSE_HTTP_PATH }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Create Databricks config file
        run: |
          mkdir -p ~/.databricks
          BENCHMARK_QUERY="${{ github.event.inputs.query }}"
          if [ -z "$BENCHMARK_QUERY" ]; then
            BENCHMARK_QUERY="select * from main.tpcds_sf1_delta.catalog_sales"
          fi
          cat > ~/.databricks/connection.json << EOF
          {
            "uri": "https://${{ env.DATABRICKS_SERVER_HOSTNAME }}${{ env.DATABRICKS_HTTP_PATH }}",
            "auth_type": "token",
            "token": "${{ env.DATABRICKS_TOKEN }}",
            "type": "databricks",
            "catalog": "main",
            "db_schema": "ADBC_Testing",
            "query": "$BENCHMARK_QUERY"
          }
          EOF
          echo "DATABRICKS_TEST_CONFIG_FILE=$HOME/.databricks/connection.json" >> $GITHUB_ENV

      - name: Build
        shell: bash
        run: |
          ./ci/scripts/csharp_build.sh "${{ github.workspace }}"

      - name: Run Benchmark (net8.0)
        shell: bash
        run: |
          export DATABRICKS_TEST_CONFIG_FILE="$HOME/.databricks/connection.json"
          ./ci/scripts/csharp_benchmark.sh "${{ github.workspace }}" "net8.0"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-net8
          path: |
            csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/*
          retention-days: 90

      - name: Extract benchmark data for trend tracking
        id: extract-data
        run: |
          # Parse BenchmarkDotNet JSON results for trend tracking
          RESULTS_FILE=$(find csharp/Benchmarks/BenchmarkDotNet.Artifacts/results -name "*-report-full-compressed.json" | head -n 1)
          if [ -f "$RESULTS_FILE" ]; then
            echo "Found results file: $RESULTS_FILE"
            # Extract mean time in nanoseconds for the first benchmark
            MEAN_NS=$(jq -r '.Benchmarks[0].Statistics.Mean' "$RESULTS_FILE")
            echo "mean_ns=$MEAN_NS" >> $GITHUB_OUTPUT

            # Convert to milliseconds for better readability
            MEAN_MS=$(echo "scale=2; $MEAN_NS / 1000000" | bc)
            echo "mean_ms=$MEAN_MS" >> $GITHUB_OUTPUT
            echo "Benchmark mean time: ${MEAN_MS}ms"
          else
            echo "Warning: Could not find benchmark results file"
          fi

      - name: Store benchmark results for trend tracking
        uses: benchmark-action/github-action-benchmark@v1
        if: steps.extract-data.outputs.mean_ns != ''
        with:
          tool: 'customBiggerIsBetter'
          output-file-path: csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/benchmark-data.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: '150%'
          comment-on-alert: false
          fail-on-alert: false
          alert-comment-cc-users: '@databricks/adbc-csharp-maintainers'
          benchmark-data-dir-path: 'bench/net8'

      - name: Create benchmark data file for trend tracking
        if: steps.extract-data.outputs.mean_ns != ''
        run: |
          mkdir -p csharp/Benchmarks/BenchmarkDotNet.Artifacts/results
          cat > csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/benchmark-data.json << EOF
          [
            {
              "name": "CloudFetch E2E Benchmark (net8.0)",
              "unit": "ms",
              "value": ${{ steps.extract-data.outputs.mean_ms }}
            }
          ]
          EOF

  benchmark-net472:
    name: Benchmark (.NET Framework 4.7.2)
    runs-on: windows-2022
    timeout-minutes: 30
    environment: azure-prod
    env:
      DATABRICKS_SERVER_HOSTNAME: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_HTTP_PATH: ${{ secrets.TEST_PECO_WAREHOUSE_HTTP_PATH }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Create Databricks config file
        shell: pwsh
        run: |
          $configDir = Join-Path $env:USERPROFILE ".databricks"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null

          $benchmarkQuery = "${{ github.event.inputs.query }}"
          if ([string]::IsNullOrEmpty($benchmarkQuery)) {
            $benchmarkQuery = "select * from main.tpcds_sf1_delta.catalog_sales"
          }

          $config = @{
            uri = "https://${{ env.DATABRICKS_SERVER_HOSTNAME }}${{ env.DATABRICKS_HTTP_PATH }}"
            auth_type = "token"
            token = "${{ env.DATABRICKS_TOKEN }}"
            type = "databricks"
            catalog = "main"
            db_schema = "ADBC_Testing"
            query = $benchmarkQuery
          } | ConvertTo-Json

          $configPath = Join-Path $configDir "connection.json"
          $config | Out-File -FilePath $configPath -Encoding utf8
          echo "DATABRICKS_TEST_CONFIG_FILE=$configPath" >> $env:GITHUB_ENV

      - name: Build
        shell: bash
        run: |
          ./ci/scripts/csharp_build.sh "${{ github.workspace }}"

      - name: Run Benchmark (net472)
        shell: bash
        run: |
          export DATABRICKS_TEST_CONFIG_FILE="$HOME/.databricks/connection.json"
          ./ci/scripts/csharp_benchmark.sh "${{ github.workspace }}" "net472"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-net472
          path: |
            csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/*
          retention-days: 90

      - name: Extract benchmark data for trend tracking
        id: extract-data
        shell: pwsh
        run: |
          $resultsFile = Get-ChildItem -Path "csharp/Benchmarks/BenchmarkDotNet.Artifacts/results" -Filter "*-report-full-compressed.json" | Select-Object -First 1
          if ($resultsFile) {
            Write-Host "Found results file: $($resultsFile.FullName)"
            $results = Get-Content $resultsFile.FullName | ConvertFrom-Json
            $meanNs = $results.Benchmarks[0].Statistics.Mean
            echo "mean_ns=$meanNs" >> $env:GITHUB_OUTPUT

            $meanMs = [math]::Round($meanNs / 1000000, 2)
            echo "mean_ms=$meanMs" >> $env:GITHUB_OUTPUT
            Write-Host "Benchmark mean time: ${meanMs}ms"
          } else {
            Write-Host "Warning: Could not find benchmark results file"
          }

      - name: Create benchmark data file for trend tracking
        if: steps.extract-data.outputs.mean_ns != ''
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "csharp/Benchmarks/BenchmarkDotNet.Artifacts/results" | Out-Null
          $benchmarkData = @(
            @{
              name = "CloudFetch E2E Benchmark (net472)"
              unit = "ms"
              value = [double]"${{ steps.extract-data.outputs.mean_ms }}"
            }
          ) | ConvertTo-Json
          $benchmarkData | Out-File -FilePath "csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/benchmark-data.json" -Encoding utf8

      - name: Store benchmark results for trend tracking
        uses: benchmark-action/github-action-benchmark@v1
        if: steps.extract-data.outputs.mean_ns != ''
        with:
          tool: 'customBiggerIsBetter'
          output-file-path: csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/benchmark-data.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: '150%'
          comment-on-alert: false
          fail-on-alert: false
          alert-comment-cc-users: '@databricks/adbc-csharp-maintainers'
          benchmark-data-dir-path: 'bench/net472'
