# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: Performance Benchmarks

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/benchmarks.yml'
      - 'csharp/src/**'
      - 'csharp/Benchmarks/**'
  pull_request:
    types: [labeled]  # Trigger when a label is added to the PR
  workflow_dispatch:
    inputs:
      query:
        description: 'Custom SQL query (single query mode - backward compatible)'
        required: false
        type: string
      queries:
        description: 'Query names from benchmark-queries.json (comma-separated or "all" for multi-query mode)'
        required: false
        default: ''
        type: string

concurrency:
  group: benchmarks-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: false

permissions:
  contents: write       # Required to push benchmark results to gh-pages branch
  pull-requests: write  # Required to post comparison comments on PRs

jobs:
  setup:
    name: Determine Benchmark Queries
    runs-on: ubuntu-latest
    outputs:
      queries_json: ${{ steps.set-queries.outputs.queries_json }}
      is_multi_query: ${{ steps.set-queries.outputs.is_multi_query }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine queries to run
        id: set-queries
        run: |
          QUERIES_INPUT="${{ github.event.inputs.queries }}"
          QUERY_INPUT="${{ github.event.inputs.query }}"
          IS_MULTI_QUERY="false"
          HAS_BENCHMARK_LABEL="${{ contains(github.event.pull_request.labels.*.name, 'benchmark') }}"

          if [ -n "$QUERIES_INPUT" ]; then
            # Multi-query mode via workflow_dispatch with queries input
            echo "Multi-query mode detected - queries input: $QUERIES_INPUT"
            if [ "$QUERIES_INPUT" = "all" ]; then
              QUERIES=$(jq -c '.' csharp/Benchmarks/benchmark-queries.json)
            else
              # Filter specific queries by name
              IFS=',' read -ra QUERY_NAMES <<< "$QUERIES_INPUT"
              FILTER=$(printf '"%s",' "${QUERY_NAMES[@]}")
              FILTER="[${FILTER%,}]"
              QUERIES=$(jq -c --argjson names "$FILTER" '[.[] | select(.name as $n | $names | index($n))]' csharp/Benchmarks/benchmark-queries.json)
            fi
            IS_MULTI_QUERY="true"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Multi-query mode on push to main
            echo "Multi-query mode detected - push to main"
            QUERIES=$(jq -c '.' csharp/Benchmarks/benchmark-queries.json)
            IS_MULTI_QUERY="true"
          elif [ "$HAS_BENCHMARK_LABEL" = "true" ] && [ "${{ github.event_name }}" = "pull_request" ]; then
            # Multi-query mode via PR benchmark label
            echo "Multi-query mode detected - benchmark label on PR"
            QUERIES=$(jq -c '.' csharp/Benchmarks/benchmark-queries.json)
            IS_MULTI_QUERY="true"
          else
            # Single-query mode (manual workflow_dispatch with custom query)
            echo "Single-query mode detected"
            if [ -n "$QUERY_INPUT" ]; then
              QUERY="$QUERY_INPUT"
            else
              QUERY="select * from main.tpcds_sf1_delta.catalog_sales"
            fi
            QUERIES=$(jq -n --arg q "$QUERY" '[{
              "name": "default",
              "description": "Custom or default query",
              "query": $q,
              "category": "custom"
            }]')
          fi

          echo "is_multi_query=$IS_MULTI_QUERY" >> $GITHUB_OUTPUT
          echo "queries_json=$QUERIES" >> $GITHUB_OUTPUT
          echo "Benchmark queries configuration:"
          echo "$QUERIES" | jq '.'
          echo "Multi-query mode: $IS_MULTI_QUERY"
          echo "Query count: $(echo "$QUERIES" | jq 'length')"

  benchmark-net8:
    name: Benchmark Suite (.NET 8.0)
    needs: setup
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'benchmark'))
    runs-on: ubuntu-latest
    timeout-minutes: 180
    environment: azure-prod
    env:
      DATABRICKS_SERVER_HOSTNAME: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_HTTP_PATH: ${{ secrets.TEST_PECO_WAREHOUSE_HTTP_PATH }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_TEST_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_TEST_CLIENT_SECRET }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build
        shell: bash
        run: |
          ./ci/scripts/csharp_build.sh "${{ github.workspace }}"

      - name: Run benchmarks sequentially
        shell: bash
        run: |
          mkdir -p ~/.databricks
          mkdir -p benchmark-results

          QUERIES='${{ needs.setup.outputs.queries_json }}'
          QUERY_COUNT=$(echo "$QUERIES" | jq 'length')

          echo "=== Running $QUERY_COUNT queries sequentially ==="

          for i in $(seq 0 $(($QUERY_COUNT - 1))); do
            QUERY_NAME=$(echo "$QUERIES" | jq -r ".[$i].name")
            QUERY_SQL=$(echo "$QUERIES" | jq -r ".[$i].query")
            QUERY_DESC=$(echo "$QUERIES" | jq -r ".[$i].description")

            echo ""
            echo "=========================================="
            echo "Query $((i + 1))/$QUERY_COUNT: $QUERY_NAME"
            echo "Description: $QUERY_DESC"
            echo "=========================================="

            # Create config file for this query
            cat > ~/.databricks/connection.json << EOF
          {
            "uri": "https://${{ env.DATABRICKS_SERVER_HOSTNAME }}${{ env.DATABRICKS_HTTP_PATH }}",
            "auth_type": "oauth",
            "grant_type": "client_credentials",
            "client_id": "${{ env.DATABRICKS_CLIENT_ID }}",
            "client_secret": "${{ env.DATABRICKS_CLIENT_SECRET }}",
            "type": "databricks",
            "catalog": "main",
            "db_schema": "ADBC_Testing",
            "query": "$QUERY_SQL"
          }
          EOF

            export DATABRICKS_TEST_CONFIG_FILE="$HOME/.databricks/connection.json"

            # Run benchmark
            if ./ci/scripts/csharp_benchmark.sh "${{ github.workspace }}" "net8.0"; then
              echo "✅ Query $QUERY_NAME completed successfully"

              # Save results with query name
              if [ -d "csharp/Benchmarks/BenchmarkDotNet.Artifacts/results" ]; then
                mkdir -p "benchmark-results/$QUERY_NAME"
                cp -r csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/* "benchmark-results/$QUERY_NAME/"

                # Clean up for next iteration
                rm -rf csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/*
              fi
            else
              echo "❌ Query $QUERY_NAME failed"
            fi
          done

          echo ""
          echo "=== Benchmark suite completed ==="

      - name: Upload all benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-net8
          path: benchmark-results/
          retention-days: 90

      - name: Generate summary
        if: needs.setup.outputs.is_multi_query == 'true'
        run: |
          echo "# Benchmark Suite Results (.NET 8.0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Query | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          for dir in benchmark-results/*; do
            if [ -d "$dir" ]; then
              query_name=$(basename "$dir")
              if [ -f "$dir"/*-report-full-compressed.json ]; then
                echo "| $query_name | ✅ Success |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $query_name | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

  benchmark-net472:
    name: Benchmark Suite (.NET Framework 4.7.2)
    needs: setup
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'benchmark'))
    runs-on: windows-2022
    timeout-minutes: 180
    environment: azure-prod
    env:
      DATABRICKS_SERVER_HOSTNAME: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_HTTP_PATH: ${{ secrets.TEST_PECO_WAREHOUSE_HTTP_PATH }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_TEST_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_TEST_CLIENT_SECRET }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build
        shell: bash
        run: |
          ./ci/scripts/csharp_build.sh "${{ github.workspace }}"

      - name: Run benchmarks sequentially
        shell: pwsh
        run: |
          $configDir = Join-Path $env:USERPROFILE ".databricks"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null
          New-Item -ItemType Directory -Force -Path "benchmark-results" | Out-Null

          $queries = '${{ needs.setup.outputs.queries_json }}' | ConvertFrom-Json
          $queryCount = $queries.Count

          Write-Host "=== Running $queryCount queries sequentially ==="

          for ($i = 0; $i -lt $queryCount; $i++) {
            $query = $queries[$i]
            $queryName = $query.name
            $querySQL = $query.query
            $queryDesc = $query.description

            Write-Host ""
            Write-Host "=========================================="
            Write-Host "Query $($i + 1)/$queryCount : $queryName"
            Write-Host "Description: $queryDesc"
            Write-Host "=========================================="

            # Create config file for this query
            $config = @{
              uri = "https://${{ env.DATABRICKS_SERVER_HOSTNAME }}${{ env.DATABRICKS_HTTP_PATH }}"
              auth_type = "oauth"
              grant_type = "client_credentials"
              client_id = "${{ env.DATABRICKS_CLIENT_ID }}"
              client_secret = "${{ env.DATABRICKS_CLIENT_SECRET }}"
              type = "databricks"
              catalog = "main"
              db_schema = "ADBC_Testing"
              query = $querySQL
            } | ConvertTo-Json

            $configPath = Join-Path $configDir "connection.json"
            $config | Out-File -FilePath $configPath -Encoding utf8
            $env:DATABRICKS_TEST_CONFIG_FILE = $configPath

            # Run benchmark
            $benchmarkPath = Join-Path "${{ github.workspace }}" "ci/scripts/csharp_benchmark.sh"
            bash $benchmarkPath "${{ github.workspace }}" "net472"

            if ($LASTEXITCODE -eq 0) {
              Write-Host "✅ Query $queryName completed successfully"

              # Save results with query name
              $resultsPath = "csharp/Benchmarks/BenchmarkDotNet.Artifacts/results"
              if (Test-Path $resultsPath) {
                $destPath = "benchmark-results/$queryName"
                New-Item -ItemType Directory -Force -Path $destPath | Out-Null
                Copy-Item -Path "$resultsPath/*" -Destination $destPath -Recurse -Force

                # Clean up for next iteration
                Remove-Item -Path "$resultsPath/*" -Recurse -Force
              }
            } else {
              Write-Host "❌ Query $queryName failed"
            }
          }

          Write-Host ""
          Write-Host "=== Benchmark suite completed ==="

      - name: Upload all benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-net472
          path: benchmark-results/
          retention-days: 90

      - name: Generate summary
        if: needs.setup.outputs.is_multi_query == 'true'
        shell: bash
        run: |
          echo "# Benchmark Suite Results (.NET Framework 4.7.2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Query | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          for dir in benchmark-results/*; do
            if [ -d "$dir" ]; then
              query_name=$(basename "$dir")
              if [ -f "$dir"/*-report-full-compressed.json ]; then
                echo "| $query_name | ✅ Success |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $query_name | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
