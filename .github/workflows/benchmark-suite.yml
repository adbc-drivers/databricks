# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: Benchmark Suite (Multi-Query)

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC
  workflow_dispatch:
    inputs:
      queries:
        description: 'Comma-separated query names (or "all")'
        required: false
        default: 'all'
        type: string

concurrency:
  group: benchmark-suite-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  setup:
    name: Load Query Configuration
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load and filter queries
        id: set-matrix
        run: |
          QUERIES_INPUT="${{ github.event.inputs.queries }}"

          if [ "$QUERIES_INPUT" = "all" ] || [ -z "$QUERIES_INPUT" ]; then
            # Use all queries from config file
            MATRIX=$(jq -c '.' csharp/Benchmarks/benchmark-queries.json)
          else
            # Filter specific queries
            IFS=',' read -ra QUERY_NAMES <<< "$QUERIES_INPUT"
            FILTER=$(printf '"%s",' "${QUERY_NAMES[@]}")
            FILTER="[${FILTER%,}]"
            MATRIX=$(jq -c --argjson names "$FILTER" '[.[] | select(.name as $n | $names | index($n))]' csharp/Benchmarks/benchmark-queries.json)
          fi

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Benchmark matrix:"
          echo "$MATRIX" | jq '.'

  benchmark:
    name: Benchmark - ${{ matrix.query.name }}
    needs: setup
    runs-on: [self-hosted, Windows, benchmark-runner]
    timeout-minutes: 45
    environment: azure-prod
    strategy:
      fail-fast: false
      matrix:
        query: ${{ fromJson(needs.setup.outputs.matrix) }}
    env:
      DATABRICKS_SERVER_HOSTNAME: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_HTTP_PATH: ${{ secrets.TEST_PECO_WAREHOUSE_HTTP_PATH }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_TEST_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_TEST_CLIENT_SECRET }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up .NET
        if: runner.environment == 'github-hosted'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Create Databricks config file
        shell: powershell
        run: |
          $configDir = Join-Path $env:USERPROFILE ".databricks"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null

          $config = @{
            uri = "https://${{ env.DATABRICKS_SERVER_HOSTNAME }}${{ env.DATABRICKS_HTTP_PATH }}"
            auth_type = "oauth"
            grant_type = "client_credentials"
            client_id = "${{ env.DATABRICKS_CLIENT_ID }}"
            client_secret = "${{ env.DATABRICKS_CLIENT_SECRET }}"
            type = "databricks"
            catalog = "main"
            db_schema = "ADBC_Testing"
            query = "${{ matrix.query.query }}"
          } | ConvertTo-Json

          $configPath = Join-Path $configDir "connection.json"
          $config | Out-File -FilePath $configPath -Encoding utf8
          echo "DATABRICKS_TEST_CONFIG_FILE=$configPath" >> $env:GITHUB_ENV

      - name: Build
        shell: bash
        run: |
          ./ci/scripts/csharp_build.sh "${{ github.workspace }}"

      - name: Run Benchmark - ${{ matrix.query.name }}
        shell: bash
        run: |
          export DATABRICKS_TEST_CONFIG_FILE="$HOME/.databricks/connection.json"
          ./ci/scripts/csharp_benchmark.sh "${{ github.workspace }}" "net8.0"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ matrix.query.name }}
          path: |
            csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/*
          retention-days: 90

      - name: Extract benchmark data
        id: extract-data
        shell: powershell
        run: |
          $resultsFile = Get-ChildItem -Path "csharp/Benchmarks/BenchmarkDotNet.Artifacts/results" -Filter "*-report-full-compressed.json" | Select-Object -First 1
          $metricsFile = Get-ChildItem -Path $env:TEMP -Filter "cloudfetch_benchmark_metrics.json" -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($resultsFile) {
            Write-Host "Found results: $($resultsFile.FullName)"
            $results = Get-Content $resultsFile.FullName | ConvertFrom-Json

            $allocatedBytes = if ($results.Benchmarks[0].Memory.BytesAllocatedPerOperation) { $results.Benchmarks[0].Memory.BytesAllocatedPerOperation } else { 0 }
            $allocatedMB = [math]::Round($allocatedBytes / 1024 / 1024, 2)
            echo "allocated_mb=$allocatedMB" >> $env:GITHUB_OUTPUT

            $gen2Collections = if ($results.Benchmarks[0].Memory.Gen2Collections) { $results.Benchmarks[0].Memory.Gen2Collections } else { 0 }
            echo "gen2_collections=$gen2Collections" >> $env:GITHUB_OUTPUT

            $minTimeNs = if ($results.Benchmarks[0].Statistics.Min) { $results.Benchmarks[0].Statistics.Min } else { 0 }
            $minTimeS = [math]::Round($minTimeNs / 1000000000, 3)
            echo "min_time_s=$minTimeS" >> $env:GITHUB_OUTPUT
          }

          if ($metricsFile) {
            Write-Host "Found metrics: $($metricsFile.FullName)"
            $metrics = Get-Content $metricsFile.FullName | ConvertFrom-Json
            $peakMemoryMB = ($metrics.PSObject.Properties | Select-Object -First 1).Value.PeakMemoryMB
            echo "peak_memory_mb=$peakMemoryMB" >> $env:GITHUB_OUTPUT
          }

      - name: Create benchmark data file
        if: steps.extract-data.outputs.peak_memory_mb != ''
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "csharp/Benchmarks/BenchmarkDotNet.Artifacts/results" | Out-Null
          $benchmarkData = @(
            @{
              name = "Min Execution Time (s)"
              unit = "seconds"
              value = [double]"${{ steps.extract-data.outputs.min_time_s }}"
            },
            @{
              name = "Peak Memory (MB)"
              unit = "MB"
              value = [double]"${{ steps.extract-data.outputs.peak_memory_mb }}"
            },
            @{
              name = "Allocated Memory (MB)"
              unit = "MB"
              value = [double]"${{ steps.extract-data.outputs.allocated_mb }}"
            },
            @{
              name = "Gen2 Collections"
              unit = "collections"
              value = [double]"${{ steps.extract-data.outputs.gen2_collections }}"
            }
          ) | ConvertTo-Json
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText("$PWD/csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/benchmark-data.json", $benchmarkData, $utf8NoBom)

      - name: Store benchmark results for trend tracking
        uses: benchmark-action/github-action-benchmark@v1
        if: steps.extract-data.outputs.peak_memory_mb != '' && github.event_name != 'pull_request'
        with:
          tool: 'customSmallerIsBetter'
          output-file-path: csharp/Benchmarks/BenchmarkDotNet.Artifacts/results/benchmark-data.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: '150%'
          fail-on-alert: false
          benchmark-data-dir-path: 'bench/${{ matrix.query.name }}'

  summary:
    name: Benchmark Summary
    needs: benchmark
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: benchmark-results

      - name: Generate summary
        run: |
          echo "# Benchmark Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Query | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          for dir in benchmark-results/benchmark-results-*; do
            if [ -d "$dir" ]; then
              query_name=$(basename "$dir" | sed 's/benchmark-results-//')
              if [ -f "$dir"/*-report-full-compressed.json ]; then
                echo "| $query_name | ✅ Success |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $query_name | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
