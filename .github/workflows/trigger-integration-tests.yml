# Copyright (c) 2025 ADBC Drivers Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
name: Trigger Integration Tests
on:
  pull_request:
    types: [labeled, synchronize]  # Trigger on label add or new commits
  merge_group:  # Trigger when added to merge queue
jobs:
  # =============================================================================
  # Security: Auto-remove label when new commits are pushed
  # =============================================================================
  remove-label-on-new-commit:
    if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
    runs-on: [self-hosted, Linux, X64, peco-driver]
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Check if integration-test label exists
        id: check-label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const hasLabel = labels.includes('integration-test');
            console.log(`integration-test label exists: ${hasLabel}`);
            return hasLabel;

      - name: Remove integration-test label
        if: steps.check-label.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'integration-test'
              });
              console.log('‚úÖ Removed integration-test label');
            } catch (error) {
              if (error.status === 404) {
                console.log('‚ÑπÔ∏è Label already removed or does not exist');
              } else {
                throw error;
              }
            }

      - name: Comment on PR about label removal
        if: steps.check-label.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const isFromFork = pr.head.repo.full_name !== pr.base.repo.full_name;
            const repoType = isFromFork ? '**fork PR**' : 'PR';

            const body = [
              'üîí **Integration test approval reset**',
              '',
              `New commits were pushed to this ${repoType}. The \`integration-test\` label has been automatically removed for security.`,
              '',
              '**A maintainer must re-review the changes and re-add the label to trigger tests again.**',
              '',
              '<details>',
              '<summary>Why is this necessary?</summary>',
              '',
              '- New code requires fresh security review',
              '- Prevents approved PRs from adding malicious code later',
              '- Ensures all tested code has been explicitly approved',
              '',
              '</details>',
              '',
              `**Latest commit**: ${pr.head.sha.substring(0, 7)}`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # =============================================================================
  # For PRs: Trigger tests when label is added
  # =============================================================================
  trigger-tests-pr:
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'labeled' &&
      contains(github.event.pull_request.labels.*.name, 'integration-test')
    runs-on: [self-hosted, Linux, X64, peco-driver]
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Detect changed driver paths
        id: changed
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100
            });
            const names = files.map(f => f.filename);
            const csharpChanged = names.some(f => f.startsWith('csharp/'));
            const rustChanged = names.some(f => f.startsWith('rust/'));
            const workflowChanged = names.some(f => f.startsWith('.github/workflows/'));
            // Workflow change triggers all targets; otherwise only changed driver folders
            const runCsharp = csharpChanged || workflowChanged;
            const runRust = rustChanged || workflowChanged;
            if (workflowChanged) console.log('‚úÖ Workflow files changed - triggering all targets');
            core.setOutput('csharp', runCsharp.toString());
            core.setOutput('rust', runRust.toString());

      - name: Generate GitHub App Token (internal repo)
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.INTEGRATION_TEST_APP_ID }}
          private-key: ${{ secrets.INTEGRATION_TEST_PRIVATE_KEY }}
          owner: databricks
          repositories: databricks-driver-test

      - name: Generate GitHub App Token (public repo)
        id: adbc-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.INTEGRATION_TEST_APP_ID }}
          private-key: ${{ secrets.INTEGRATION_TEST_PRIVATE_KEY }}
          owner: adbc-drivers
          repositories: databricks

      - name: Dispatch C# tests to internal repo
        if: steps.changed.outputs.csharp == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: databricks/databricks-driver-test
          event-type: adbc-csharp-pr-test
          client-payload: |
            {
              "pr_number": "${{ github.event.pull_request.number }}",
              "commit_sha": "${{ github.event.pull_request.head.sha }}",
              "pr_repo": "${{ github.repository }}",
              "pr_url": "${{ github.event.pull_request.html_url }}",
              "pr_title": "${{ github.event.pull_request.title }}",
              "pr_author": "${{ github.event.pull_request.user.login }}"
            }

      - name: Dispatch Rust tests to internal repo
        if: steps.changed.outputs.rust == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: databricks/databricks-driver-test
          event-type: adbc-rust-pr-test
          client-payload: |
            {
              "pr_number": "${{ github.event.pull_request.number }}",
              "commit_sha": "${{ github.event.pull_request.head.sha }}",
              "pr_repo": "${{ github.repository }}",
              "pr_url": "${{ github.event.pull_request.html_url }}",
              "pr_title": "${{ github.event.pull_request.title }}",
              "pr_author": "${{ github.event.pull_request.user.login }}"
            }

      - name: Pass Integration Tests check (C# not needed)
        if: steps.changed.outputs.csharp != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.adbc-token.outputs.token }}
          script: |
            await github.rest.checks.create({
              owner: 'adbc-drivers',
              repo: 'databricks',
              name: 'C# Integration Tests',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: 'success',
              completed_at: new Date().toISOString(),
              output: {
                title: 'Skipped - no C# changes',
                summary: '‚úÖ No C# driver files changed.'
              }
            });

      - name: Pass Rust Integration Tests check (Rust not needed)
        if: steps.changed.outputs.rust != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.adbc-token.outputs.token }}
          script: |
            await github.rest.checks.create({
              owner: 'adbc-drivers',
              repo: 'databricks',
              name: 'Rust Integration Tests',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: 'success',
              completed_at: new Date().toISOString(),
              output: {
                title: 'Skipped - no Rust changes',
                summary: '‚úÖ No Rust driver files changed.'
              }
            });

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'üöÄ Integration tests triggered! [View workflow run](https://github.com/databricks/databricks-driver-test/actions)'
            });
  # =============================================================================
  # For Merge Queue: Check if relevant files changed
  # =============================================================================
  check-merge-queue-paths:
    if: github.event_name == 'merge_group'
    runs-on: [self-hosted, Linux, X64, peco-driver]
    outputs:
      csharp-changed: ${{ steps.check-paths.outputs.csharp_changed }}
      rust-changed: ${{ steps.check-paths.outputs.rust_changed }}
      should-test: ${{ steps.check-paths.outputs.should_test }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check if relevant files changed
        id: check-paths
        run: |
          BASE_SHA="${{ github.event.merge_group.base_sha }}"
          HEAD_SHA="${{ github.event.merge_group.head_sha }}"
          echo "Checking files changed between $BASE_SHA and $HEAD_SHA"
          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")

          CSHARP_CHANGED=false
          RUST_CHANGED=false

          if echo "$CHANGED_FILES" | grep -q "^csharp/"; then
            echo "‚úÖ C# files changed"
            CSHARP_CHANGED=true
          fi
          if echo "$CHANGED_FILES" | grep -q "^rust/"; then
            echo "‚úÖ Rust files changed"
            RUST_CHANGED=true
          fi
          if echo "$CHANGED_FILES" | grep -q "^\.github/workflows/"; then
            echo "‚úÖ Workflow files changed - triggering all targets"
            CSHARP_CHANGED=true
            RUST_CHANGED=true
          fi

          echo "csharp_changed=$CSHARP_CHANGED" >> $GITHUB_OUTPUT
          echo "rust_changed=$RUST_CHANGED" >> $GITHUB_OUTPUT

          if [ "$CSHARP_CHANGED" = true ] || [ "$RUST_CHANGED" = true ]; then
            echo "should_test=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Relevant files changed - will run tests"
          else
            echo "should_test=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No driver/workflow files changed - will auto-approve"
          fi
  # =============================================================================
  # For Merge Queue: Check if tests already passed on PR
  # =============================================================================
  check-previous-run:
    needs: check-merge-queue-paths
    if: github.event_name == 'merge_group' && needs.check-merge-queue-paths.outputs.should-test == 'true'
    runs-on: [self-hosted, Linux, X64, peco-driver]
    outputs:
      already-passed: ${{ steps.check-pr.outputs.passed }}
      pr-number: ${{ steps.extract-pr.outputs.pr_number }}
    steps:
      - name: Extract PR number from merge queue ref
        id: extract-pr
        run: |
          # Merge queue ref format: refs/heads/gh-readonly-queue/{base_branch}/pr-{pr_number}-{sha}
          REF="${{ github.event.merge_group.head_ref }}"
          echo "Full ref: $REF"
          # Extract PR number
          if [[ $REF =~ pr-([0-9]+) ]]; then
            PR_NUMBER="${BASH_REMATCH[1]}"
            echo "Extracted PR number: $PR_NUMBER"
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Could not extract PR number from ref"
            echo "pr_number=" >> $GITHUB_OUTPUT
          fi
      - name: Generate GitHub App Token
        if: steps.extract-pr.outputs.pr_number != ''
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.INTEGRATION_TEST_APP_ID }}
          private-key: ${{ secrets.INTEGRATION_TEST_PRIVATE_KEY }}
          owner: adbc-drivers
          repositories: databricks
      - name: Check if tests passed on current PR head
        if: steps.extract-pr.outputs.pr_number != ''
        id: check-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const prNumber = '${{ steps.extract-pr.outputs.pr_number }}';
            if (!prNumber) {
              console.log('No PR number found');
              return false;
            }
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            console.log(`PR #${prNumber} head SHA: ${pr.head.sha}`);
            // Check both required checks passed on current PR head SHA
            const checkNames = ['C# Integration Tests', 'Rust Integration Tests'];
            const results = await Promise.all(checkNames.map(name =>
              github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha,
                check_name: name
              })
            ));
            for (let i = 0; i < checkNames.length; i++) {
              const name = checkNames[i];
              const runs = results[i].data.check_runs;
              const passing = runs.filter(r => r.conclusion === 'success' && r.head_sha === pr.head.sha);
              if (passing.length === 0) {
                console.log(`‚ùå No passing check found for "${name}"`);
                return false;
              }
              console.log(`‚úÖ "${name}" passed on current head`);
            }
            return true;
  trigger-tests-merge:
    needs: [check-merge-queue-paths, check-previous-run]
    if: needs.check-previous-run.outputs.already-passed != 'true'
    runs-on: [self-hosted, Linux, X64, peco-driver]
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.INTEGRATION_TEST_APP_ID }}
          private-key: ${{ secrets.INTEGRATION_TEST_PRIVATE_KEY }}
          owner: databricks
          repositories: databricks-driver-test
      - name: Dispatch C# tests to internal repo
        if: needs.check-merge-queue-paths.outputs.csharp-changed == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: databricks/databricks-driver-test
          event-type: adbc-csharp-pr-test
          client-payload: |
            {
              "pr_number": "${{ needs.check-previous-run.outputs.pr-number }}",
              "commit_sha": "${{ github.event.merge_group.head_sha }}",
              "pr_repo": "${{ github.repository }}",
              "pr_url": "https://github.com/${{ github.repository }}/pull/${{ needs.check-previous-run.outputs.pr-number }}",
              "pr_title": "Merge queue validation",
              "pr_author": "merge-queue"
            }
      - name: Dispatch Rust tests to internal repo
        if: needs.check-merge-queue-paths.outputs.rust-changed == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: databricks/databricks-driver-test
          event-type: adbc-rust-pr-test
          client-payload: |
            {
              "pr_number": "${{ needs.check-previous-run.outputs.pr-number }}",
              "commit_sha": "${{ github.event.merge_group.head_sha }}",
              "pr_repo": "${{ github.repository }}",
              "pr_url": "https://github.com/${{ github.repository }}/pull/${{ needs.check-previous-run.outputs.pr-number }}",
              "pr_title": "Merge queue validation",
              "pr_author": "merge-queue"
            }
  auto-approve-no-relevant-changes:
    needs: check-merge-queue-paths
    if: github.event_name == 'merge_group' && needs.check-merge-queue-paths.outputs.should-test == 'false'
    runs-on: [self-hosted, Linux, X64, peco-driver]
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.INTEGRATION_TEST_APP_ID }}
          private-key: ${{ secrets.INTEGRATION_TEST_PRIVATE_KEY }}
          owner: adbc-drivers
          repositories: databricks
      - name: Create passing checks (no relevant changes)
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const headSha = '${{ github.event.merge_group.head_sha }}';
            for (const name of ['C# Integration Tests', 'Rust Integration Tests']) {
              await github.rest.checks.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name,
                head_sha: headSha,
                status: 'completed',
                conclusion: 'success',
                completed_at: new Date().toISOString(),
                output: {
                  title: 'Auto-approved - no relevant changes',
                  summary: '‚úÖ No driver or workflow files changed. Skipping tests.'
                }
              });
            }
  auto-approve-already-passed:
    needs: check-previous-run
    if: needs.check-previous-run.outputs.already-passed == 'true'
    runs-on: [self-hosted, Linux, X64, peco-driver]
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.INTEGRATION_TEST_APP_ID }}
          private-key: ${{ secrets.INTEGRATION_TEST_PRIVATE_KEY }}
          owner: adbc-drivers
          repositories: databricks
      - name: Create passing checks (auto-approve)
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const headSha = '${{ github.event.merge_group.head_sha }}';
            for (const name of ['C# Integration Tests', 'Rust Integration Tests']) {
              await github.rest.checks.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name,
                head_sha: headSha,
                status: 'completed',
                conclusion: 'success',
                completed_at: new Date().toISOString(),
                output: {
                  title: 'Auto-approved for merge queue',
                  summary: '‚úÖ Tests already passed on PR head commit. Skipping duplicate test run.'
                }
              });
            }
